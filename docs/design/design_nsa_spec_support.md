# Support Compliance Reports

## Overview

It is required to leverage starboard security tools capabilities by adding the support for building compliance reports 
example : NSA - Kubernetes Hardening Guidance

## Solution

### TL;DR;

 - A new `ComplianceController` will be added  and track the `ClusterComplianceReport` and trigger a compliance report ( a.k.a. NSA.) generation on every pre-define interval
 - The report generation content will be determined by spec file.
 - The spec file will include mapping between control id and tools report (cis-kube-bench and config-audit) raw data.
 - Two new CRDs 
   - `ClusterComplianceReport` to provide summary of the compliance per control
   - `ClusterComplianceDetailReport` to provide more detail compliance report for further investigation
 - it is assumed that all tools (kube-bench / config-audit) are running by default all the time and producing raw data

### The Spec :
- The spec will include the mapping (based on Ids) between the compliance report and tools(kube-bench and config-audit) which generate the raw data
- there are 2 option how to consume the spec file : 

#### option 1  - yaml section as part of spec on ClusterComplianceReport CRD

| #   | Pros                                      | cons                                                  |
|-----|-------------------------------------------|-------------------------------------------------------|
| 1   | easy to explain to  community             | exposed to user and can be amended (need to protect)  |
| 2   | more fit to operator standard             | make  CRD output big <br/>(as its included in config) |
| 3   | trigger the reconcile loop for compliance | have to be deployed as part of starboard installation |

#### option 2  - store it as yaml on pod file system 

| #   | Pros                                              | cons                                                                               |
|-----|---------------------------------------------------|------------------------------------------------------------------------------------|
| 1   | not visible to user and cannot be amended         | in order to trigger the reconcile loop<br/> starboard will deploy and empty report |
| 2   | report will include only scanning data not config |                                                                                    |

#### Example for spec  :

```yaml
---
kind: compliance
name: NSA
description: National Security Agency - Kubernetes Hardening Guidance
version: 1.0
generationInterval : 6h
controls:
  - name: Non-root containers
    description: ''
    id: '1.0'
    resources:
      - Workload
    mapping:
      tool: config-audit
      checks:
        - id: KSV012
  - name: protect kube-config secrets
    description: ''
    id: '1.1'
    resources:
      - Node
    mapping:
      tool: kube-bench
      checks:
        - id: 1.11.2
  ....
 ``` 
### The logic :
Option 1 : Upon starboard deployment a `ClusterComplianceReport` with specification data (example above) will be deployed to the cluster.
Option 2 : Upon starboard startup an empty `ClusterComplianceReport` will be deployed (if not exist already)

The CRD deployment will trigger the `ComplianceController` reconcile loop which will track the `ClusterComplianceReport` resource.
Upon event arrival the `ComplianceController` will check if the time match the interval for report generation
- `no match` - the event will be re-queue for the remaining time of the interval
- `match` - A `ClusterComplianceReport` and `ClusterComplianceDetailReport` will be generated by mapping raw data from tools to spec file

### The mapping
Once it is determined that a report need to be generated:
 - all reports (cis-benchmark and audit config) raw data will be fetched by `tool` and `resource` types
 - starboard will iterate all fetched raw data and find a match by `ID`
 - once the data has been mapped and aggregated 2 type of reports will be generated to present summary 
   data and detailed data (in case further investigation need to be made)
 
### Note: once the report has been generated again to reconcile loop start again the process describe in logic

### The Reports:

#### Compliance summary report
```json
{
    "apiVersion": "aquasecurity.github.io/v1alpha1",
    "kind": "ClusterComplianceReport",
    "metadata": {
        "annotations": {
            "starboard.aquasecurity.github.io/report-next-generation": "3s"
        },
        "creationTimestamp": "2022-02-13T11:25:28Z",
        "generation": 3,
        "name": "nsa",
        "resourceVersion": "485633",
        "uid": "80049b23-efbe-46a7-b670-9b4b52ddee72"
    },
    "report": {
        "control_check": [
            {
                "failTotal": 9,
                "id": "1.0",
                "name": "Non-root containers",
                "passTotal": 0,
                "severity": ""
            },
            {
                "failTotal": 0,
                "id": "6.0",
                "name": "Ensure kube config file permission",
                "passTotal": 2,
                "severity": ""
            }
            .
            .
            .
        ],
        "summary": {
            "failCount": 25,
            "passCount": 3
        },
        "type": {
            "description": "national security agency - kubernetes hardening guidance",
            "kind": "compliance",
            "name": "nsa",
            "version": "1.0"
        },
        "updateTimestamp": "2022-02-13T11:32:23Z"
    }
}

```

#### Compliance details report
```json
{
  "apiVersion": "aquasecurity.github.io/v1alpha1",
  "kind": "ClusterComplianceReport",
  "metadata": {
    "annotations": {
      "starboard.aquasecurity.github.io/report-next-generation": "3s"
    },
    "creationTimestamp": "2022-02-13T11:25:28Z",
    "generation": 3,
    "name": "nsa",
    "resourceVersion": "485633",
    "uid": "80049b23-efbe-46a7-b670-9b4b52ddee72"
  },
  "report": {
    "control_check": [
      {
        "id": "1.0",
        "name": "Non-root containers",
        "checkResults": [
          {
            "objectKind": "DaemonSet",
            "remediation": "fix a b c",
            "details": [
              {
                "name": "daemonset-kindnet-kindnet-cni",
                "namespace": "kube-system",
                "status": "fail"
              }
            ]
          }
        ]
      },
      {
        "id": "6.0",
        "name": "Ensure kube config file permission",
        "checkResults": [
          {
            "objectKind": "Pod",
            "remediation": "fix d e f",
            "details": [
              {
                "name": "pod-kube-apiserver-local-control-plane-kube-apiserver",
                "namespace": "kube-system",
                "status": "fail"
              }
            ]
          }
        ]
      }
    ],
    "type": {
      "description": "national security agency - kubernetes hardening guidance",
      "kind": "compliance",
      "name": "nsa",
      "version": "1.0"
    },
    "updateTimestamp": "2022-02-13T11:32:23Z"
  }
}
```

### The CRDs
#### ClusterComplianceReport CRD :
- a new CRD `clustercompliancereports.crd.yaml` will be added to include compliance check report

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: clustercompliancereports.aquasecurity.github.io
  labels:
    app.kubernetes.io/managed-by: starboard
    app.kubernetes.io/version: "0.14.1"
spec:
  group: aquasecurity.github.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      additionalPrinterColumns:
        - jsonPath: .report.type.kind
          type: string
          name: report
          description: The name of the complience report
        - jsonPath: .metadata.creationTimestamp
          type: date
          name: Age
          description: The age of the report
        - jsonPath: .report.summary.failCount
          type: integer
          name: Fail
          priority: 1
          description: The number of checks that failed with Danger status
        - jsonPath: .report.summary.passCount
          type: integer
          name: Pass
          priority: 1
          description: The number of checks that passed
      schema:
        openAPIV3Schema:
          x-kubernetes-preserve-unknown-fields: true
          type: object
  scope: Cluster
  names:
    singular: clustercompliancereport
    plural: clustercompliancereports
    kind: ClusterComplianceReport
    listKind: ClusterComplianceReportList
    categories: []
    shortNames:
      - compliance
```

#### ClusterComplianceDetailReport CRD :
- a new CRD `clustercompliancedetailreports.crd.yaml` will be added to include compliance detail check report

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: clustercompliancedetailreports.aquasecurity.github.io
  labels:
    app.kubernetes.io/managed-by: starboard
    app.kubernetes.io/version: "0.14.1"
spec:
  group: aquasecurity.github.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      additionalPrinterColumns:
        - jsonPath: .report.type.kind
          type: string
          name: report
          description: The name of the complience report
        - jsonPath: .metadata.creationTimestamp
          type: date
          name: Age
          description: The age of the report
        - jsonPath: .report.summary.failCount
          type: integer
          name: Fail
          priority: 1
          description: The number of checks that failed with Danger status
        - jsonPath: .report.summary.passCount
          type: integer
          name: Pass
          priority: 1
          description: The number of checks that passed
      schema:
        openAPIV3Schema:
          x-kubernetes-preserve-unknown-fields: true
          type: object
  scope: Cluster
  names:
    singular: clustercompliancedetailreport
    plural: clustercompliancedetailreports
    kind: ClusterComplianceDetailReport
    listKind: ClusterComplianceDetailReportList
    categories: []
    shortNames:
      - compliancedetail
```

### Tools Code Changes
#### kube-bench - a new kube-bench profile check `nsa-1.0` will be added with the following checks for `Node` resource kind:
   - new
      - `use a default policy to deny all ingress and egress traffic` check that netowork policy deny all exist
      - `Usege of LimitRange` check the limit range resource has been define
      - `EncryptionConfiguration` check that encryption resource has been set
      - `service mesh usage` check serve mesh is used in cluster

#### Note: in order to check cluster resource existence check we will have to introduce a new functionality to kube-bench

### Permission changes:

it is required to update `02-starboard-operator.rbac.yaml` rules to include new permissions
to support the following tracked resources kind by NSA plugin with (get,list and watch):
 ```yaml
- apiGroups: ["networking.k8s.io"]
  resources:
    - networkpolicies
  verbs:
    - get
    - list
    - watch
```
```yaml
- apiGroups: ["apiserver.config.k8s.io"]
  resources:
    - encryptionconfigurations
  verbs:
    - get
    - list
    - watch
```
```yaml
- apiGroups:
      - ""
    resources:
      - limitranges
    verbs:
      - get
      - list
      - watch
```

### NSA Tool Analysis

| Test                                                                                          | Description                                                                                             | Kind                                                                        | Tool        | Test                                                                                                                          |
|-----------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|-------------|-------------------------------------------------------------------------------------------------------------------------------|
| Non-root containers                                                                           | Check that container is not running as root                                                             | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield : <br/>kubernetes/policies/pss/restricted/3_runs_as_root.rego                                                       |
| Immutable container file systems                                                              | check that container root <br/>file system is immutable                                                 | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/general/file_system_not_read_only.rego                                                         |
| Scan container images vulnerabilities                                                         | scan container for vulnerabilities<br/> and misconfiguration                                            | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Trivy       | Trivy                                                                                                                         |
| Privileged container                                                                          | Controls whether Pods can run privileged containers.                                                    | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/baseline/2_privileged.rego                                                                 |
| hostIPC                                                                                       | Controls whether containers can share<br/> host process namespaces                                      | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/baseline/1_host_ipc.rego                                                                   |
| hostPID                                                                                       | Controls whether containers can share host process namespaces.                                          | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/baseline/1_host_pid.rego                                                                   |
| hostNetwork                                                                                   | Controls whether containers can use the host network.                                                   | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/baseline/1_host_network.rego                                                               |
| allowedHostPaths                                                                              | Limits containers to specific paths of the host file system.                                            | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | Need to be added to appshield :<br/> https://kubernetes.io/docs/concepts/policy/pod-security-policy/#volumes-and-file-systems |
| readOnlyRootFilesystem                                                                        | Requires the use of a read only root file system                                                        | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/general/file_system_not_read_only.rego                                                         |
| runAsUser , runAsGroup <br/>and supplementalGroups                                            | Controls whether container applications can run <br/>with root privileges or with root group membership | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/restricted/4_runs_with_a_root_gid.rego                                                     |
| allowPrivilegeEscalation                                                                      | Restricts escalation to root privileges.                                                                | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/restricted/2_can_elevate_its_own_privileges.rego                                           |
| seLinux                                                                                       | Sets the SELinux context of the container.                                                              | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/baseline/7_selinux_custom_options_set.rego                                                 |
| AppArmor annotations                                                                          | Sets the seccomp profile used to sandbox containers.                                                    | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/baseline/6_apparmor_policy_disabled.rego                                                   |
| seccomp annotations                                                                           | Sets the seccomp profile used to sandbox containers.                                                    | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/pss/restricted/5_runtime_default_seccomp_profile_not_set.rego                                  |
| Protecting Pod service account tokens                                                         | disable secret token been mount ,automountServiceAccountToken: false                                    | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/advance/protecting_pod_service_account_tokens.rego                                             |
| kube-system or kube-public                                                                    | namespace kube-system should should not be used by users                                                | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/advance/protect_core_components_namespace.rego                                                 |
| Use CNI plugin that supports NetworkPolicy API                                                | check cni plugin installed                                                                              | Node                                                                        | Kube-bench  | 5.3.1 Ensure that the CNI in use supports Network Policies (need to be fixed)                                                 |
| Create policies that select <br/>Pods using podSelector and/or the namespaceSelector          | Create policies that select Pods using podSelector<br/> and/or the namespaceSelector                    | Pod,ReplicationController,ReplicaSet,<br/>StatefulSet,DaemonSet,Job,CronJob | Conftest    | appshield: kubernetes/policies/advance/selector_usage_in_network_policies.rego                                                |
| use a default policy to deny all ingress and egress traffic                                   | check that network policy deny all exist                                                                | NetworkPolicy                                                               | Kube-bench  | Add logic to kube-bench <br/>https://kubernetes.io/docs/concepts/services-networking/network-policies/                        |
| Use LimitRange and ResourceQuota<br/> policies to limit resources on a namespace or Pod level | check the limit range resource has been define                                                          | LimitRange                                                                  | Kube-bench  | Add Logic to kube-bench <br/>https://kubernetes.io/docs/concepts/policy/limit-range/                                          |
| TLS encryption                                                                                | control plan disable insecure port                                                                      | Node                                                                        | Kube-bench  | 1.2.19 Ensure that the --insecure-port argument is set to 0                                                                   |
| Etcd encryption                                                                               | encrypt etcd communication                                                                              | Node                                                                        | Kube-bench  | 2.1 Ensure that the --cert-file and --key-file arguments are set as appropriate                                               |
| Kubeconfig files                                                                              | ensure file permission                                                                                  | Node                                                                        | Kube-bench  | 4.1.3, 4.1.4                                                                                                                  |
| Worker node segmentation                                                                      | node segmentation                                                                                       | Node                                                                        | Kube-bench  | Note sure can be tested                                                                                                       |
| Encryption                                                                                    | check that encryption resource has been set                                                             | EncryptionConfiguration                                                     | Kube-bench  | Add Logic to kube-bench https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/                                     |
| Encryption / secrets                                                                          | check encryption provider                                                                               | Node                                                                        | Kube-bench  | 1.2.3 Ensure that the --encryption-provider-config argument is set as                                                         |
| authentication                                                                                | make sure anonymous-auth is unset                                                                       | Node                                                                        | Kube-bench  | 1.2.1 Ensure that the --anonymous-auth argument is set to false                                                               |~~
| Role-based access control                                                                     | make sure -authorization-mode=RBAC                                                                      | Node                                                                        | Kube-bench  | 1.2.7/1.2.8 Ensure that the --authorization-mode argument is not set to AlwaysAllow                                           |
| Audit policy file                                                                             | check that policy is configure                                                                          | Node                                                                        | Kube-bench  | 3.2.1 Ensure that a minimal audit policy is created                                                                           |
| Audit log path                                                                                | check that log path is configure                                                                        | Node                                                                        | Kube-bench  | 1.2.22 Ensure that the --audit-log-path argument is set                                                                       |
| Audit log max age                                                                             | check audit log aging                                                                                   | Node                                                                        | Kube-bench  | 1.2.23 Ensure that the --audit-log-maxage argument is set to 30 or as appropriate                                             |~~
| service mesh usage                                                                            | check service mesh is used in cluster                                                                   | Node                                                                        | Kube-bench  | Add Logic to kube-bench check service mesh existenace                                                                         |


## Open Items
- nsa support for CLI (need to discuss implementation)

### spec file example

```
### Next Steps
- POC NSA controller
- need to solve a bug to log conftest ID , it is logging title instead
- inconsistency between cis-kube-bench and conf-audit check tests 
  - conf-audit only show pass summary and do not log pass check
  - cis-kube-bench log pass checks and summary
- Enhance POC code and make it production ready
- Fix and Add tests
- Completed all missing check from appshield - Done
- Add support for nsa 1.0 spec in kube-bench
- Completed missing checks in kube-bench
- Add support for starboard CLI